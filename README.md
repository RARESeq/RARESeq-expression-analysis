[RARE-Seq Analysis Workflow]{.s1}

[Version 4.0]{.s1}

[Description]{.s2}

[The RARE-Seq analysis workflow consists of the following steps:]{.s1}

[1.]{.s1}[     ]{.s3}[**Import RSEM expected counts**. This step uses
the tximport R package to merge expected counts, expected lengths, and
transcript per million (TPM) values generated by RSEM into a single R
object to be used by downstream steps.]{.s1}

[2.]{.s1}[     ]{.s3}[**Normalize expression**. This step calculates
log-transformed and normalized gene expression (log2NX) for captured
coding genes across all samples. Expression normalization may be done
using TPM (from RSEM) or TMM (Trimmed Mean of M values method from
edgeR). For the TMM method, a subset of samples may be labeled as
"meta-reference" in the sample file, which will be used to calculate the
gene-wise M values.  In addition, platelet-based correction may be done
using RUVg or RUVs methods.]{.s1}

[***For cfRNA enrichment score (ES) analysis***:]{.s1}

[3.]{.s1}[     ]{.s3}[**Calculate z-scores**. This step calculates
gene-wise z-scores for all samples. Z-scores are calculated using the
average and standard deviation of gene expression in the subset of
samples that have been labeled as "meta-reference" in the sample file
input. If no meta-reference is provided, the entire cohort is used as
the meta-reference.]{.s1}

[4.]{.s1}[     ]{.s3}[**Calculate enrichment scores**. This step
calculates sample-wise enrichment scores for the input gene
signature(s). Gene signatures are filtered to include only the genes
that intersect with the Z-score matrix input into this step.]{.s1}

[***For differential expression analysis***:]{.s1}

[5.]{.s1}[     ]{.s3}[**Identify differentially expressed genes**. This
step uses the DESeq2 R package to determine differentially expressed
genes according to the specified model equation.]{.s1}

[***For building cancer versus control elastic net classifier***:]{.s1}

[6.]{.s1}[     ]{.s3}[**Set up elastic net model training inputs.** This
step combines gene expression and variant-based features into a single
matrix to be used for the elastic net classifier model training.
Features are then filtered to include 1) genes that are expressed in
either LUAD tumor tissue or meta-reference cfRNA, 2) genes that are
significantly differentially expressed when comparing LUAD tumor tissue
to meta-reference cfRNA, and 3) genes that are not associated with sex
(i.e., genes that are significantly differentially expressed in male
versus female meta-reference cfRNA, or specific to reproductive cell
types in PanglaoDb, or on sex chromosomes). Pre-processing is done to
remove features with near-zero variance in the training cohort, followed
by standardization. In addition, samples are split into training and
validation sets, and the training set is further separated into N folds
to be used for model cross validation.]{.s1}

[7.]{.s1}[     ]{.s3}[**Train elastic net model**. This step uses the
caret and glmnet R packages to train an elastic net model with the
selected samples and selected features. Model training uses feature
weights for feature-specific regularization. Model training is further
restricted so that only features with positive coefficients are
selected.]{.s1}

[8.]{.s1}[     ]{.s3}[**Validate elastic net model.** This step uses the
caret and glmnet R packages to predict cancer likelihood scores in the
withheld validation samples.]{.s1}

[The RARE-Seq analysis workflow has an expected runtime of about 5
minutes.[ ]{.Apple-converted-space}]{.s1}

[Set up]{.s2}

[Anaconda should be installed on linux operating system before running
the RARE-Seq analysis workflow. Once conda is installed and initialized,
the RARE-Seq analysis conda environment can be created. Example set-up
commands are below.]{.s1}

[conda init bash]{.s1}

[conda update -n base conda]{.s1}

[conda config \--add channels defaults]{.s1}

[conda config \--add channels bioconda]{.s1}

[conda config \--add channels conda-forge]{.s1}

[conda config \--set channel_priority false]{.s1}

[conda env create -f rareseq_env.yml]{.s1}[ ]{.s4}[-n rareseq_env]{.s1}

[ ]{.s1}

[The environment contains the following dependencies:]{.s1}

[-]{.s1}[       ]{.s3}[bioconductor-biocparallel=1.28.3]{.s1}

[-]{.s1}[       ]{.s3}[bioconductor-deseq2=1.34.0]{.s1}

[-]{.s1}[       ]{.s3}[bioconductor-edger=3.36.0]{.s1}

[-]{.s1}[       ]{.s3}[bioconductor-fgsea=1.20.0]{.s1}

[-]{.s1}[       ]{.s3}[bioconductor-limma=3.50.3]{.s1}

[-]{.s1}[       ]{.s3}[bioconductor-ruvseq=1.28.0]{.s1}

[-]{.s1}[       ]{.s3}[bioconductor-tximport=1.22.0]{.s1}

[-]{.s1}[       ]{.s3}[r-ashr=2.2_54]{.s1}

[-]{.s1}[       ]{.s3}[r-base=4.1.3]{.s1}

[-]{.s1}[       ]{.s3}[r-caret=6.0_93]{.s1}

[-]{.s1}[       ]{.s3}[r-combinat=0.0_8]{.s1}

[-]{.s1}[       ]{.s3}[r-data.table=1.14.2]{.s1}

[-]{.s1}[       ]{.s3}[r-glmnet=4.1_2]{.s1}

[-]{.s1}[       ]{.s3}[r-ggpubr=0.4.0]{.s1}

[-]{.s1}[       ]{.s3}[r-mass=7.3_58.1]{.s1}

[-]{.s1}[       ]{.s3}[r-mixtools=1.2.0]{.s1}

[-]{.s1}[       ]{.s3}[r-proc=1.18.0]{.s1}

[-]{.s1}[       ]{.s3}[r-tidyverse=1.3.2]{.s1}

[ ]{.s1}

[The set-up steps above only need to be run once. On the other hand, the
conda environment will need to be activated before each instance of
running the RARE-Seq analysis workflow.]{.s1}

[conda activate rareseq_env]{.s1}

[ ]{.s1}

[]{.s1}\

[ ]{.s2}

[Step #1:]{.s2}[ Import RSEM expected counts.]{.s1}

[Example Usage:]{.s1}

[Rscript importExpression.R \<INPUT DIRECTORY\> \<SAMPLE FILE\>]{.s1}

[Input Parameters:]{.s1}

[1.]{.s1}[     ]{.s3}[**Input directory** Path to single directory
containing all RSEM output files with ".genes.results" suffix.]{.s1}

[2.]{.s1}[     ]{.s3}[**Sample file** A tab-delimited file listing
samples to use for RARE-Seq analysis.]{.s1}

[[ ]{.Apple-tab-span}a. The file must minimally include the column(s)
below.]{.s1}

[[ ]{.Apple-tab-span}[ ]{.Apple-tab-span} ]{.s3}[i.]{.s1}[    
]{.s3}["ID": Unique sample identifier]{.s1}

[[ ]{.Apple-tab-span}]{.s3}[b. ]{.s5}[Additional columns may be
included.]{.s1}

[Output Files:]{.s1}

[1.]{.s1}[     ]{.s3}[**Tximport RDS file** An RDS file named
"tximport.rds" containing data output by RSEM and re-formatted into a
list of 3 matrices. The list contains 1) matrix with expected counts
("counts"), 2) matrix with expected length ("length"), and 3) matrix
with transcripts per million (TPM) ("abundance"). For each matrix, genes
are listed as rows and samples as columns.]{.s1}

[ ]{.s1}

[Step #2:]{.s2}[  Normalize expression.]{.s1}

[Example Usage:]{.s1}

[Rscript normalizeExpression.R \<TXIMPORT RDS FILE\> \<GENE FILE\>
\<SAMPLE FILE\> \<NORMALIZATION METHOD\> \<CORRECTION METHOD\>
\<NEGATIVE CONTROL GENE FILE\>]{.s1}

[Input Parameters:]{.s1}

[1.]{.s1}[     ]{.s3}[**Tximport RDS file** The tximport RDS file output
from step #1.]{.s1}

[2.]{.s1}[     ]{.s3}[**Gene file** A tab-delimited file containing the
list of gene identifiers to include in the normalization and downstream
steps.]{.s1}

[[ ]{.Apple-tab-span}a.]{.s1}[     ]{.s3}[The file must minimally
include the column(s) below.]{.s1}

[[ ]{.Apple-tab-span}[ ]{.Apple-tab-span} ]{.s3}[i.]{.s1}[    
]{.s3}["gene_id_simplified": Ensembl gene identifier. The gene version
number should be removed, e.g. "ENSG00000196230" instead of
"ENSG00000196230.12".]{.s1}

[3.]{.s1}[     ]{.s3}[**Sample file** A tab-delimited file listing
samples to use for RARE-Seq analysis. All samples included in this file
must have also been included in the sample file used for step #1, and
the same sample file can be used for both steps. ]{.s1}

[[ ]{.Apple-tab-span}a.]{.s1}[     ]{.s3}[The file must minimally
include the column(s) below.]{.s1}

[[ ]{.Apple-tab-span}[ ]{.Apple-tab-span} ]{.s3}[i.]{.s1}[    
]{.s3}["ID": Unique sample identifier]{.s1}

[[ ]{.Apple-tab-span}[ ]{.Apple-tab-span} ]{.s3}[ii.]{.s1}[    
]{.s3}["group": Relevant sample categorization (i.e., "cancer" and
"control")]{.s1}

[[ ]{.Apple-tab-span}[ ]{.Apple-tab-span} ]{.s3}[iii.]{.s1}[    
]{.s3}["Reference": Meta-reference samples may be marked "yes" or "NA"
to indicate whether the sample is or is not included in the
meta-reference subset, respectively.]{.s1}

[[ ]{.Apple-tab-span}b.]{.s1}[     ]{.s3}[The file may include the
columns below if step #7 is to be run.]{.s1}

[[ ]{.Apple-tab-span}[ ]{.Apple-tab-span} ]{.s3}[i.]{.s1}[    
]{.s3}["EN: Sample labels including "train", "validation", or "NA", if
they are to be used for model training, used for model validation, or
excluded (i.e., meta-reference samples), respectively.]{.s1}

[[ ]{.Apple-tab-span}c.]{.s1}[     ]{.s3}[Additional columns may be
included.]{.s1}

[4.]{.s1}[     ]{.s3}[**Normalization method** A character string for
the appropriate normalization method and must be set to "NONE", "TMM",
or "TPM".]{.s1}

[5.]{.s1}[     ]{.s3}[**Correction method** A character string for the
appropriate correction method and must be set to "NONE", "RUVg", or
"RUVs".]{.s1}

[6.]{.s1}[     ]{.s3}[**Negative control gene file** A tab-delimited
file listing the genes to use for RUVg correction, and therefore is
required if "RUVg" is specified above. For cfRNA analysis, the default
is to use platelet marker genes for RUVg correction.]{.s1}

[[ ]{.Apple-tab-span}a.]{.s1}[     ]{.s3}[The file must minimally
include the column(s) below.]{.s1}

[[ ]{.Apple-tab-span}[ ]{.Apple-tab-span} ]{.s3}[i.]{.s1}[    
]{.s3}["gene_id_simplified": Ensembl gene identifier. The gene version
number should be removed, e.g. "ENSG00000196230" instead of
"ENSG00000196230.12".]{.s1}

[Output Files:]{.s1}

[2.]{.s1}[     ]{.s3}[**Normalized RDS file** An RDS file named
according to the \<NORMALIZATION METHOD\> and \<CORRECTION METHOD\>"
input. The list contains 1) data.frame with input gene information
("genes"), 2) data.frame with input sample information ("samples"), 3)
matrix of RSEM expected counts ("counts"), 4) matrix of RSEM expected
length ("length"), and 5) matrix of normalized gene expression
("log2NX"). For last 3 matrices, genes are listed as rows and samples as
columns.]{.s1}

[ ]{.s1}

[Step #3:]{.s2}[ Calculate z-scores.]{.s1}

[Example Usage:]{.s1}

[Rscript calcZcores.R \<NORMALIZED RDS FILE\>]{.s1}

[Input Parameters:]{.s1}

[1.]{.s1}[     ]{.s3}[**Normalized RDS file** The RDS file output from
step #2.]{.s1}

[Output Files:]{.s1}

[1.]{.s1}[     ]{.s3}[**Normalized RDS file with Z-scores** An RDS file
containing the same matrices as output for step #2 but with the matrix
of z-scores added and with *"\_withZscores*" appended to the file name.
If meta-reference samples were specified in the sample information file
in step #2, these samples will be used for Z-score standardization and
will therefore be removed from the Z-score matrix.]{.s1}

[** **]{.s1}

[Step #4:]{.s2}[ Calculate enrichment scores.]{.s1}

[Example Usage:]{.s1}

[Rscript calcEnrichment.R \<NORMALIZED RDS FILE WITH ZSCORES\>
\<ENRICHMENT METHOD\> \<GENE SIGNATURE FILE\> \<OUTPUT DIRECTORY\>]{.s1}

[Input Parameters:]{.s1}

[1.]{.s1}[     ]{.s3}[**Normalized RDS file with Z-scores** The RDS file
output from step #3.]{.s1}

[2.]{.s1}[     ]{.s3}[**Enrichment method** A character string
specifying the desired method for calculating enrichment scores. The
default method is "*stouffer*", which uses Stouffer's method to combine
multiple weighted Z-scores into a single gene signature enrichment
score. The method may also be "*percentile_X*" and if so, X should be
replaced by a numeric value in \[0,1\] (e.g., 0.9) to be used as the cut
point among weighted Z-scores within the gene signature defining the
gene signature enrichment score. Finally, the method may be set to
"*sum*", which simply adds together the weighted Z-scores to calculate
the gene signature enrichment score.]{.s1}

[3.]{.s1}[     ]{.s3}[**Gene signature(s) file** A tab-delimited file
containing the list of genes in the gene signature(s) of interest.]{.s1}

[a.]{.s1}[     ]{.s3}[The file must minimally include the column(s)
below.]{.s1}

[                                               ]{.s3}[i.]{.s1}[    
]{.s3}["gene_id_simplified": Ensembl gene identifier. The gene version
number should be removed, e.g. "ENSG00000196230" instead of
"ENSG00000196230.12".]{.s1}

[b.]{.s1}[     ]{.s3}[The file may include the columns below.]{.s1}

[                                               ]{.s3}[i.]{.s1}[    
]{.s3}["gene_set_name": Gene set name(s). Multiple gene signatures may
be run but must be distinguished with unique names in this column.]{.s1}

[                                              ]{.s3}[ii.]{.s1}[    
]{.s3}["weight": Gene weight(s) to use for the specified enrichment
method. If no weights are provided, all gene weights are set to 1.]{.s1}

[4.]{.s1}[     ]{.s3}[**Output directory** A character string providing
the name of the directory in which to output the enrichment score
results. Since this step can be run multiple times for multiple gene
signature files, each run should use a unique output directory name to
avoid overwriting data.]{.s1}

[Output Files:]{.s1}

[1.]{.s1}[     ]{.s3}[**Enrichment scores file** A tab-delimited file
containing the enrichment scores and associated empirical p-values for
each sample for each gene signature.]{.s1}

[ ]{.s1}

[Step #5:]{.s2}[ Identify differentially expressed genes.]{.s1}

[Example Usage:]{.s1}

[Rscript differentialExpression.R \<NORMALIZED RDS FILE\> \<DIFFERENTIAL
EXPRESSION METHOD\> \<MODEL EQUATION\>]{.s1}

[Input Parameters:]{.s1}

[1.]{.s1}[     ]{.s3}[**Normalized RDS file** The RDS file output from
step #2.]{.s1}

[2.]{.s1}[     ]{.s3}[**Differential expression method** A character
string specifying which differential expression method to use and must
be either "DESeq2" or "DESeq2shrink". The latter runs log fold change
(LFC) shrinkage using the ashr method to provide better gene ranking by
effect size. More information is provided in the DESeq2 tutorial and
vignettes
(https://bioconductor.org/packages/release/bioc/vignettes/DESeq2/inst/doc/DESeq2.html).]{.s1}

[3.]{.s1}[     ]{.s3}[**Model equation** A character string providing
the equation used to model differential expression. This equation must
use column headers that are present in the sample information matrix in
the RDS file input (which come from the sample information file input in
step #2). For example, for a simple case-control analysis, the model
equation may be "\~group" to determine differentially expressed genes
between two (or more) sample groups as distinguished in this column.
More information is provided in the DESeq2 tutorial and vignettes
(https://bioconductor.org/packages/release/bioc/vignettes/DESeq2/inst/doc/DESeq2.html).]{.s1}

[Output Files:]{.s1}

[1.]{.s1}[     ]{.s3}[**Differential expression file(s)** A
tab-delimited file containing the log fold change and adjusted p-values
for differential expression based on the provided model equation. One
file will be output for each contrast evaluated.]{.s1}

[ ]{.s1}

[Step #6:]{.s2}[ Set up elastic net training inputs.]{.s1}

[Example Usage:]{.s1}

[Rscript setupEN.R \<NORMALIZED RDS FILE\> \<GENOTYPING FILE\>]{.s1}

[Input Parameters:]{.s1}

[1.]{.s1}[     ]{.s3}[**Normalized RDS file** The RDS file output from
step #2. The sample info matrix must include a column using the header
"EN" that specifies the subset of samples to be used for model training
("train"), the subset of samples to be used for model validation
("validation"), and meta-reference to be excluded from this step
("NA").]{.s1}

[2.]{.s1}[     ]{.s3}[**Genotyping file** (Optional) The tab-delimited
file output by the targeted-caller script, named
"variant_call_table.txt". If not provided, only gene expression features
will be used for model training.]{.s1}

[Output Files:]{.s1}

[3.]{.s1}[     ]{.s3}[**Normalized RDS file for Caret** An RDS file with
"*\_forCaret.rds*" appended to the filename. The RDS object contains 1)
data.frame of gene information that has been filtered to include only
features to be used for model training, 2) data.frame of sample
information that has been filtered to include only samples to be used
for model training, 3) matrices of standardized features to be used as
predictors for model training and validation, 4) binarized vectors to be
used as outcome variable (e.g. case/1 or control/0) for model training
and validation. See the **Description** section for more information
about how feature filtering and pre-processing.]{.s1}

[ ]{.s1}

[Step #7:]{.s2}[ Train elastic net model.]{.s1}

[Example Usage:]{.s1}

[Rscript trainEN.R \<NORMALIZED RDS FILE FOR CARET\>]{.s1}

[Input Parameters:]{.s1}

[1.]{.s1}[     ]{.s3}[**Normalized RDS file for Caret** The RDS file
output from step #7.]{.s1}

[Output Files:]{.s1}

[4.]{.s1}[     ]{.s3}[**Model selected features file** A tab-delimited
file named "model_selected_features.txt" that contains feature
coefficients. A feature coefficient above zero indicates feature
selection.]{.s1}

[5.]{.s1}[     ]{.s3}[**Model sample predictions file** A tab-delimited
file named "model_sample_predictions.txt" that contains the cancer
likelihood score for all training samples.]{.s1}

[6.]{.s1}[     ]{.s3}[**Model metrics file** A tab-delimited file named
"model_metrics.txt" that contains area under the curve (AUC) calculated
either using the full training set ("Train") or using the 10-fold cross
validation results ("CV"). ]{.s1}

[7.]{.s1}[     ]{.s3}[**Model RDS file** An RDS file named "model.rds"
that contains the final model as output by the caret R package.]{.s1}

[ ]{.s1}

[Step #8:]{.s2}[ Validate elastic net model.]{.s1}

[Example Usage:]{.s1}

[Rscript validateEN.R \<NORMALIZED RDS FILE FOR CARET\> \<MODEL RDS
FILE\>]{.s1}

[Input Parameters:]{.s1}

[1.]{.s1}[     ]{.s3}[**Normalized RDS file for Caret** The RDS file
output from step #7.]{.s1}

[2.]{.s1}[     ]{.s3}[**Model RDS file** The RDS file output from step
#8.]{.s1}

[Output Files:]{.s1}

[1.]{.s1}[     ]{.s3}[**Model sample predictions file** A tab-delimited
file named "model_sample_predictions_validation.txt" that contains the
cancer likelihood score for all withheld validation samples.]{.s1}

[2.]{.s1}[     ]{.s3}[**Model metrics file** A tab-delimited file named
"model_metrics_validation.txt" that contains the area under the curve
\*AC) calculated using the validation set ("Validation").]{.s1}
